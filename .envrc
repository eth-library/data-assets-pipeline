# Nix flake + direnv integration
#
# Plain direnv re-evaluates the flake on every shell entry, which can be quite slow (~5-10s).
# nix-direnv caches the evaluation as a Nix GC root so subsequent
# loads are near-instant. If the developer doesn't have nix-direnv installed
# globally, we fetch it once (hash-verified) and cache it in ~/.config/direnv/.
# See: https://github.com/nix-community/nix-direnv
if ! has nix_direnv_version; then
  source_url "https://raw.githubusercontent.com/nix-community/nix-direnv/3.1.0/direnvrc" \
    "sha256-yMJ2OVMzrFaDPn7q8nCBZFRYpL/f0RcHzhmw/i6btJM="
fi
use flake

# Watch for changes to trigger environment reload
watch_file pyproject.toml
watch_file flake.nix
watch_file flake.lock
watch_file uv.lock

# Environment variables
export DAGSTER_HOME="$PWD/.dagster"
export VIRTUAL_ENV="$PWD/.venv"

# Setup Python dependencies
uv sync --extra dev --all-packages --quiet || log_error "Python setup failed"
PATH_add "$PWD/.venv/bin"

# Show welcome message
dap welcome
