# Use the Nix flake in this directory
use flake

# Watch for changes in these files to trigger environment reload
watch_file pyproject.toml
watch_file flake.nix
watch_file uv.lock

echo ""
echo "ETH Library Zurich - Data Archive Pipeline (DAP) - Orchestrator"
echo "───────────────────────────────────────────────────────────────"

export DAGSTER_HOME="$PWD"

# Auto-create venv and sync dependencies
if [ ! -d .venv ]; then
    echo "○ creating venv..."
    uv venv --quiet
fi

source .venv/bin/activate
uv sync --extra dev --frozen --quiet

echo ""
echo "  Environment"
echo "  ─────────────────────────────────────────────────────────────"
echo "  nix flake       $(nix flake metadata --json 2>/dev/null | jq -r '.resolved.url' | sed 's|^file://||')"
echo "  python venv     $VIRTUAL_ENV"
echo "  python version  $(python --version 2>&1 | cut -d' ' -f2)"
echo "  DAGSTER_HOME    $DAGSTER_HOME"
echo ""
echo "  Commands"
echo "  ─────────────────────────────────────────────────────────────"
echo "  just            show available commands"
echo "  just info       show tool versions"
echo "  just dev        start Dagster dev server"
echo ""
