name: CLI

on:
  push:
    branches: [main]
    paths: ['cli/**']
  pull_request:
    paths: ['cli/**']

permissions:
  contents: read

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: cachix/install-nix-action@v31
      - name: Run tests
        run: nix develop .#cli-dev --command dap cli test

  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: cachix/install-nix-action@v31
      - name: Run go vet
        run: nix develop .#cli-dev --command bash -c "cd cli && go vet ./..."
      - name: Check formatting
        run: |
          nix develop .#cli-dev --command bash -c '
            cd cli
            unformatted=$(gofmt -l .)
            if [ -n "$unformatted" ]; then
              echo "Files not formatted:"
              echo "$unformatted"
              exit 1
            fi
          '
